version: '3.8'

networks:
  laravel:
    driver: bridge

services:
  testapi:
    build:
      dockerfile: ./dockerfiles/app.Dockerfile
      context: .
    image: ${APP_IMAGE}
    restart: unless-stopped
    container_name: test
    volumes:
      - ${APP_VOLUMES_SRC}:/var/www/html
    env_file:
      - ./envs/app.env
    networks:
      - laravel
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  test-nginx:
    depends_on:
      - testapi
    image: nginx:stable-alpine3.17
    restart: unless-stopped
    container_name: test-nginx
    ports:
      - ${NGINX_PORT}:80
    volumes:
      - ${APP_VOLUMES_SRC}:/var/www/html
      - ${SERVER_SRC}:/etc/nginx/conf.d/default.conf
    networks:
      - laravel
